<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Commuter Departure App</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23007BFF' width='180' height='180' rx='40'/><text x='50%' y='50%' font-size='80' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='central'>üöç</text></svg>">
  <meta name="description" content="Small app to calculate what time you should leave to arrive on time">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#007BFF">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    .dark-toggle { position: fixed; top: 12px; right: 12px; background: none; border: none; font-size: 24px; cursor: pointer; }
    .error { color: #dc2626; font-weight: 600; margin-top: 8px; }
    .success { color: #059669; font-weight: 600; }
    .info { color: #0284c7; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>

<button class="dark-toggle" id="themeToggle" title="Toggle dark mode">üåô</button>

<h2>Commuter Departure Time Calculator</h2>

<label for="route">Route:</label>
<select id="route" aria-label="Route">
  <option value="bus101">Bus 101 - Main St (20m)</option>
  <option value="bus202">Bus 202 - Downtown (35m)</option>
  <option value="trainA">Train A - Express (25m)</option>
  <option value="debug">Debug (0m)</option>
</select>

<label for="arrivalTime">Arrival Time:</label>
<input type="time" id="arrivalTime" aria-required="true">

<label for="buffer">Buffer (minutes):</label>
<input type="number" id="buffer" value="10" min="0" aria-label="Buffer minutes">

<button class="full" onclick="calculateDeparture()">Calculate Departure</button>

<button id="notifBtn" class="notification-btn" onclick="enableNotifications()" style="background-color: #ffc107; margin-top: 15px; display: none; color: #000;">üîî Enable Notifications</button>
<div id="notifStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>

<div id="result" role="status" aria-live="polite"></div>
<div id="countdown" style="margin-top:10px; font-weight:bold;"></div>

<script>

// Dark mode toggle with localStorage persistence
function initDarkMode() {
  const toggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('theme') || 'auto';
  
  function applyTheme(theme) {
    if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.style.colorScheme = 'dark';
      toggle.textContent = '‚òÄÔ∏è';
    } else {
      document.documentElement.style.colorScheme = 'light';
      toggle.textContent = 'üåô';
    }
    localStorage.setItem('theme', theme === 'auto' ? 'auto' : theme);
  }
  
  toggle.addEventListener('click', () => {
    const current = localStorage.getItem('theme') || 'auto';
    const next = current === 'auto' ? 'light' : (current === 'light' ? 'dark' : 'auto');
    applyTheme(next);
  });
  
  applyTheme(savedTheme);
}

initDarkMode();

// Check and display notification status on page load
function updateNotificationStatus() {
  const notifBtn = document.getElementById('notifBtn');
  const notifStatus = document.getElementById('notifStatus');
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  
  if ("Notification" in window) {
    if (Notification.permission === "granted") {
      notifStatus.innerHTML = '<span class="success">‚úÖ Notifications enabled!</span>';
      notifBtn.style.display = "none";
    } else if (Notification.permission === "denied") {
      notifStatus.innerHTML = `<span class="error">${isIOS 
        ? "‚ö†Ô∏è iOS PWA notifications not fully supported. Use native reminders instead." 
        : "‚ùå Notifications blocked. Enable in browser settings."}</span>`;
      notifBtn.style.display = isIOS ? "none" : "block";
    } else {
      notifStatus.innerHTML = '<span class="info">üîî Tap the button below to enable notifications</span>';
      notifBtn.style.display = "block";
    }
  } else {
    notifStatus.innerHTML = '<span class="error">‚ö†Ô∏è Your browser doesn\'t support notifications.</span>';
    notifBtn.style.display = "none";
  }
}

// Enable notifications with user interaction
async function enableNotifications() {
  if ("Notification" in window) {
    try {
      const permission = await Notification.requestPermission();
      updateNotificationStatus();
      if (permission === "granted") {
        new Notification("‚úÖ Notifications Ready!", {
          body: "You'll get an alert when it's time to leave.",
          tag: "notification-test"
        });
      }
    } catch (err) {
      console.error("Notification error:", err);
      document.getElementById('notifStatus').innerHTML = '<span class="error">‚ùå Could not enable notifications. Please try again.</span>';
    }
  }
}

// Update status on page load and when app comes to foreground
window.addEventListener('load', updateNotificationStatus);
window.addEventListener('focus', updateNotificationStatus);

// Main calculation function with improved error handling
async function calculateDeparture() {
  const route = document.getElementById("route").value;
  const arrivalTime = document.getElementById("arrivalTime").value;
  const buffer = parseInt(document.getElementById("buffer").value, 10);
  const resultDiv = document.getElementById("result");

  // Validate input
  if (!arrivalTime) {
    resultDiv.innerHTML = '<span class="error">‚ùå Please enter an arrival time.</span>';
    return;
  }

  if (isNaN(buffer) || buffer < 0) {
    resultDiv.innerHTML = '<span class="error">‚ùå Buffer must be a positive number.</span>';
    return;
  }

  // Parse arrival time to check if it's valid
  const [arrivalHours, arrivalMins] = arrivalTime.split(":").map(Number);
  const arrivalToday = new Date();
  arrivalToday.setHours(arrivalHours, arrivalMins, 0, 0);
  
  if (arrivalToday < new Date()) {
    resultDiv.innerHTML = '<span class="error">‚ùå Arrival time has already passed today. Please enter a future time.</span>';
    return;
  }

  try {
    resultDiv.innerHTML = '<span class="info">‚è≥ Calculating...</span>';
    
    const response = await fetch("/api/calculate-departure", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ route, arrivalTime, buffer }),
      credentials: "same-origin"
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`API Error ${response.status}:`, errorText);
      throw new Error(`Server error: ${response.status}`);
    }

    const data = await response.json();

    if (data.error) {
      resultDiv.innerHTML = `<span class="error">‚ùå ${data.error}</span>`;
      return;
    }

    resultDiv.innerHTML = `<span class="success">‚úÖ You should leave at <strong>${data.departureTime}</strong></span><div class="info">Travel time: ${data.travelTime}m + ${buffer}m buffer = ${data.travelTime + buffer}m total</div>`;

    startCountdown(data.departureTime);
    scheduleNotification(data.departureTime);

  } catch (err) {
    console.error("API Error Details:", err.message, err.stack);
    console.error("Full Error:", err);
    const userMsg = err.message || 'Could not connect to API. Try checking if the page is still loading.';
    resultDiv.innerHTML = `<span class="error">‚ùå ${userMsg}</span>`;
  }
}

function scheduleNotification(departureTime) {
  if (Notification.permission !== "granted") {
    document.getElementById("result").innerHTML += '<div class="info" style="margin-top: 8px;">üí° Enable notifications to get an alert when it\'s time to leave.</div>';
    return;
  }

  const now = new Date();
  const [hours, minutes] = departureTime.split(":").map(Number);

  const departureDate = new Date();
  departureDate.setHours(hours, minutes, 0, 0);

  // If departure time already passed today, stop
  if (departureDate <= now) {
    document.getElementById("result").innerHTML += '<div class="error" style="margin-top: 8px;">‚ö†Ô∏è Departure time has already passed.</div>';
    return;
  }

  const delay = departureDate - now;

  setTimeout(() => {
    new Notification("‚è∞ Time to Leave!", {
      body: `Leave now to arrive at ${departureTime}. Safe travels! üöç`,
      tag: "departure-time",
      requireInteraction: true
    });
  }, delay);
}

let countdownInterval;

function startCountdown(departureTime) {
  clearInterval(countdownInterval);

  countdownInterval = setInterval(() => {
    const now = new Date();
    const [h, m] = departureTime.split(":").map(Number);

    const target = new Date();
    target.setHours(h, m, 0, 0);

    const diff = target - now;

    if (diff <= 0) {
      document.getElementById("countdown").innerHTML = '<span class="success">üöç Time to leave!</span>';
      clearInterval(countdownInterval);
      return;
    }

    const mins = Math.floor(diff / 60000);
    const secs = Math.floor((diff % 60000) / 1000);

    document.getElementById("countdown").innerText = `Leaving in ${mins}m ${secs}s`;
  }, 1000);
}

// Register service worker for PWA support
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then((reg) => {
    console.log('‚úÖ Service Worker registered');
  }).catch((err) => {
    console.warn('‚ö†Ô∏è Service Worker registration failed:', err);
  });
}

</script>

</body>
</html>
